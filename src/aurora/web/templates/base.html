{% load static feature_flags http2 %}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="version" content="{{ project.version|slice:':7'|join:'' }}">
    <meta name="date" content="{{ project.build_date }}">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    {% block meta %}{% endblock meta %}
    <title>Registration</title>
    <link href="https://unpkg.com/tailwindcss@1.9.6/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="{% static "base.css" %}">
    <link href="{% static "staff-toolbar.css" %}" type="text/css" media="all" rel="stylesheet">
    <link rel="stylesheet" href="{% static "admin/debug.css" %}">

    <script src="https://code.jquery.com/jquery-3.6.0.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script>
    {% block cache %}{#<script src="{% static "cache.min.js" %}"></script>#}{% endblock %}

    {% block head %}{% endblock head %}
</head>
<body class="min-h-screen">
<script>
    const LANGUAGE_CODE = "{{ LANGUAGE_CODE }}";
</script>
{% block header %}
    <header class="text-gray-700 body-font border-b border-gray-200 header">
        <div class="container-fluid w-100 mx-auto flex flex-wrap p-5 md:flex-row items-center">
            <div class="flex-none align-middle">
                <a class="flex title-font font-medium items-center text-gray-900 mb-4 md:mb-0" href="/">
                </a>
            </div>
            <div class="flex-grow"></div>
            <div>
                <img alt="hope logo" src="{% static "hope1.webp" %}" height="40">
            </div>
        </div>
    </header>
{% endblock %}
{% block body %}
{% endblock body %}
{% block footer %}{% include "_footer.html" %}

{% endblock %}

<script type="text/javascript">
let db;

const state = {
    online: "ONLINE",
    offline: "OFFLINE"
}

const registerServiceWorker = () => {
    if ("serviceWorker" in navigator) {
        navigator.serviceWorker
            .register("/serviceworker.js", {
            scope: '/'
        }).then((registration) => {
            console.log(`Service worker for scope ${registration.scope} registered`);
        },
        (err) => {
            console.log('django-pwa: ServiceWorker registration failed: ', err);
        });

        if (navigator.serviceWorker.controller) {
            console.log("Service worker installed");
        }

        navigator.serviceWorker.oncontrollerchange = event => {
            console.log("New service worker activated");
        }
    } else {
        console.log("Service worker is not supported");
    }
}

registerServiceWorker();

const initDB = () => {
    let request = indexedDB.open('forms', 1);

    request.onerror = function(e) {
      console.error('Unable to open database.');
    }

    request.onsuccess = function(e) {
      db = e.target.result;
      console.log('DB opened');
    }

    request.onupgradeneeded = function(e) {
        db = e.target.result;
        db.createObjectStore("cachedForms", {keyPath:"id", autoIncrement: true});
    }
}


// Doubled from serviceworker.js
const synchronizeRegistrationVersion = () => {
    const url = "http://localhost:8000/en-us/";

    fetch(`${url}get_pwa_enabled/`)
    .then(fetchResponse => fetchResponse.json())
    .then(response => {
        const searchedUrl = `/en-us/register/${response.slug}/${response.version}/`;

        caches.open("staticCache-1").then(cache => {
            cache.keys().then(keys => {
                keys.forEach(key => {
                    if (key.url.match(/\/register\//)) {
                        cache.delete(key).then(() => `Key ${key} deleted from cache`)
                    }
                })
            }).then(() => {
                cache.add(searchedUrl)
                .then(() => console.log("Version of pwa-enabled registration synchronized"))
            })
        })
    })
    .catch(err => console.log(`Sorry, we couldn't synchronize data because of this error: ${err}`));
};


const prepareFormData = dataObj => {
  const dataForm = new FormData();

  Object.keys(dataObj).map(key => {
    console.log(key, typeof dataObj[key]);
    dataForm.append(key, dataObj[key])
  });
  return dataForm;
}

const sendData = (url, dataForm) => {
  const xhr = new XMLHttpRequest();
  xhr.open('POST', `http://localhost:8000${url}`);
  xhr.send(dataForm);

  return xhr
}

const loopOverDB = () => {
    let transaction  = db.transaction(['cachedForms'], 'readonly');

    let objectStore = transaction.objectStore('cachedForms');
    objectStore.openCursor().addEventListener("success", event => {
        let cursor = event.target.result;
        if (cursor) {
            let record = cursor.value;
            const url = record.url;

            delete record.id;
            delete record.url;

            const dataForm = prepareFormData(record);
            const xhr = sendData(url, dataForm);

            xhr.addEventListener('load', () => {
              console.log("Data sent successfully to sever.");
            });

            xhr.addEventListener('error', () => {
              console.log("Oops! Something went wrong.");
            });

            cursor.continue();
        }
    });
}

const clearFormsDB = () => {
    let objectStore  = db.transaction(['cachedForms'], 'readwrite').objectStore('cachedForms');

    const objectStoreRequest = objectStore.clear();
    objectStoreRequest.addEventListener("success", () => {
        console.log("Indexeddb forms cleared")
    });
}

window.addEventListener("online", () => {
    console.log(`Application is ${state.online}`);

    initDB();
    synchronizeRegistrationVersion();
    setTimeout(() => {
        loopOverDB();
    }, 2500);
    setTimeout(() => {
        clearFormsDB()
    }, 5000)

});

window.addEventListener("offline", () => {
    console.log(`Application is ${state.offline}`);
});

</script>

</body>
</html>
