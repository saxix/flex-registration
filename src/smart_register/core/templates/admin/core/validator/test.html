{% extends "admin_extra_buttons/action_page.html" %}
{% block extrahead %}
    {{ block.super }}
    {{ form.media }}
    <style>
        .message{
            display: flex;
            align-items: center;
        }
        .message .icon{
            width: 50px;
            height: 50px;
            background: white url('/static/admin/img/icon-unknown.svg') no-repeat center;
            background-size: 50px 50px;
        }
        .icon.question{
            background-image: url('/static/admin/img/icon-unknown.svg');
        }
        .icon.error{
            background-image: url('/static/admin/img/icon-alert.svg');
        }
        .icon.valid{
            background-image: url('/static/admin/img/icon-yes.svg');
        }
        .icon.invalid{
            background-image: url('/static/admin/img/icon-no.svg');
        }
        #log{
            overflow-scrolling: auto;
            max-height: 300px;
        }
    </style>
{% endblock %}
{% block action-content %}
    <div class="message">
        <div class="icon"></div>
        <pre id="messages"></pre>
    </div>
    <form method="post">
        {% csrf_token %}
        <table width="100%">
            <tr>
                <td colspan="2">
                    {{ form.code }}
                </td>
            </tr>
            <tr>
                <td  style="width: 100px">
                    {{ form.input }}
                </td>
                <td style="width: 500px">
                    <pre id="log" style="width: 100%"></pre>
                </td>
            </tr>
        </table>
        <input type="submit">
    </form>
{% endblock action-content %}
{% block document_ready %}
    {{ block.super }}
    <script>
        (function ($) {
            $(document).ready(function () {
                window.console.out = function (msg) {
                    $log.prepend(msg + "\n");
                }
                let message = "{{ original.message }}"
                let $icon = $(".message .icon");
                let editor = $("#id_code").data("CodeMirror");
                let input = $("#id_input").data("CodeMirror");
                let $log = $("#log");
                let $messages =  $('#messages');
                let updateSource = function () {
                    let code = editor.getValue();
                    let param = input.getValue();
                    let source = "var value=" + param + ";" + code;
                    run(source);
                };
                let run = function (c) {
                    try {
                        $messages.text("");
                        let ret = eval(c);
                        if (ret === true){
                            $icon.prop("class", "icon").addClass("valid");
                        }else{
                            $icon.prop("class", "icon").addClass("invalid");
                            $messages.text(ret);
                        }
                    } catch (error) {
                        $icon.prop("class", "icon").addClass("error");
                        $messages.text(error)
                        console.error(error);
                    }
                };
                editor.on("change", updateSource);
                input.on("change", updateSource);
                updateSource();
            });
        })(django.jQuery);
    </script>
{% endblock %}
