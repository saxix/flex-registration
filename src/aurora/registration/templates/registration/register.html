{% extends "base.html" %}{% load aurora formset l10n static itrans http2 %}
{% block meta %}
    <meta name="Description" content="Module: '{{ registration.title}}' Version: {{ registration.version }} - Form version: {{ form.flex_form.version }}">
    <meta name="Survey" content="{{ registration.slug }}">
    <meta name="Version" content="1{{ registration.version }}">
{% endblock meta %}
{% block cache %}{% endblock %}
{% block head %}
    <script src="{% static "admin/js/vendor/jquery/jquery.js" %}"></script>
    <script src="{% url 'javascript-catalog' registration.locale %}"></script>
    <script src="{% static 'registration/survey.min.js' %}"></script>
    <script src="https://browser.sentry-cdn.com/5.30.0/bundle.min.js"
            integrity="sha384-V+jCLoAVKKml0VanRLGJGAdKk+Lzo1kRFe079J0majdfeGabOd32KG/2adGnr4N0"
            crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/js-cookie/3.0.1/js.cookie.min.js"
            integrity="sha512-wT7uPE7tOP6w4o28u1DN775jYjHQApdBnib5Pho4RB0Pgd9y7eSkAV1BTqQydupYDB9GBhTcQQzyNMPMV3cAew=="
            crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    {{ media }}
{% endblock head %}
{% block header %}
    {{ block.super }}
    <div id="loading" class="h-screen flex justify-center bg-gray-100 pb-10">
        Loading...
    </div>
{#    {% if registration.locales|length > 1 %}#}
    <div class="flex flex-row px-5">
    <div class="flex-grow">
        {% include "i18n/_select_language.html" with languages=registration.languages %}
    </div>
    <div class="flex-shrink">
        <a href="{% url "logout" %}">logout</a>
    </div>
    </div>
{#    {% endif %}#}
{% endblock %}

{% block body %}
    {% include "smart/_form.html" %}

<script>
  if (isOnline === undefined || isOnline === null) {
      const isOnline = "onLine" in navigator && navigator.onLine;
  }

  const createObjectData = formElement => {
    let formData = {};

    // Iterate over formData and create object with properties
    for (let i = 0; i < formElement.elements.length; i++) {
        let el = formElement.elements[i];
        if (el.name && el.value) {
            if (el.name === "image") {
                const inputEl = document.getElementsByName(el.name)[0];
                if (inputEl.type === "file") {
                    {# TODO img serialize #}
                    formData[el.name] = inputEl.files[0].serializeToString();
                }
            }
            formData[el.name] =  el.value
        }
    }
    return formData;
  }

  const button = document.querySelector('input[type=submit]');

  if (button && isOnline) {
      button.addEventListener("click", event => {
          event.preventDefault();
          const formElement = document.forms.registrationForm;
          if (formElement) {
              const formData = createObjectData(formElement);

              // load path to know on which url post data when online
              const path = window.location.pathname;
              formData["url"] = path;

              const localStorageId = `id-${new Date().getTime()}`;
              localStorage.setItem(localStorageId, JSON.stringify(formData));
          }

          alert("Form sent, we will contact you");
      });
  }
</script>

{% endblock body %}
{% block footer %}
    {% if registration.locales|length > 1 %}
        <script defer src="{% static 'i18n/i18n.min.js' %}"></script>
    {% endif %}
    {% if can_translate %}
        <script src="{% static 'i18n/i18n_edit.js' %}"></script>
        <script defer src="{% static "edit.min.js" %}"></script>
    {% endif %}
    <script defer src="{% static "registration/auth.js" %}"></script>
    {% if registration.advanced.smart.wizard %}<script src="{% static "wizard.min.js" %}"></script>{% endif %}
    <div class="flex justify-center text-xs footer m-auto pt-1 pb-2 border-t-2 text-gray-400 border-gray-400">
        {{ project.build_date }} - {{ LANGUAGE_CODE }}
    </div>
    <script>var VERSION="{{ project.version }}";var DSN="{{ project.sentry_dsn }}";</script>
    <script src="{% static "page.min.js" %}"></script>
    {% if registration.client_validation %}
    <script src="{% static "validation.min.js" %}"></script>
    {% endif %}
    {{ registration.media }}
{% endblock footer %}
